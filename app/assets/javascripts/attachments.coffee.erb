(->
  createStorageKey = undefined
  host = undefined
  uploadAttachment = undefined
  document.addEventListener 'trix-attachment-add', (event) ->
    attachment = undefined
    attachment = event.attachment
    if attachment.file
      return uploadAttachment(attachment)
    return
  host = 'https://d1s87wv3twdpn6.cloudfront.net/'

  uploadAttachment = (attachment) ->
    file = undefined
    form = undefined
    key = undefined
    xhr = undefined
    file = attachment.file
    key = createStorageKey(file)
    form = new FormData
    form.append 'key', key
    form.append 'Content-Type', file.type
    form.append 'file', file
    xhr = new XMLHttpRequest
    xhr.open 'POST', host, true

    xhr.upload.onprogress = (event) ->
      progress = undefined
      progress = event.loaded / event.total * 100
      attachment.setUploadProgress progress

    xhr.onload = ->
      href = undefined
      url = undefined
      if xhr.status == 204
        url = href = host + key
        return attachment.setAttributes(
          url: url
          href: href)
      return

    xhr.send form

  createStorageKey = (file) ->
    date = undefined
    day = undefined
    time = undefined
    date = new Date
    day = date.toISOString().slice(0, 10)
    time = date.getTime()
    'tmp/' + day + '/' + time + '-' + file.name

  return
).call this

# ---
# generated by js2coffee 2.2.0